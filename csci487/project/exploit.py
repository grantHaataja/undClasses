"""
"Start the exploitation station."

Description: exploit is a software used for gaining unauthorized access to remote
computers. There are different exploits within the framework for the user to choose
from. Upon running the exploit software, user will need to choose the exploit to
try, enter the target IP address, enter the port to connect to, and then type
"run" to attempt the exploit.

Usage: exploit
"""
# Would like 2 different exploit options to start with
# one for 'windoors' systems and one for 'lionux' systems

from funfunctions import dots


def run(*args, **kwargs):
    emptyList = True
    for arg in args:
        if arg:
            emptyList = False
    assert len(args) == 0 or emptyList, "Invalid use of exploit.\n\nUsage: exploit"

    print('***Welcome to the exploitation station***')
    print('Available exploits:')

    vdb = kwargs['game'].vuln_database
    visible_exploits = [name for name in vdb if not name.startswith('_')]
    exploits = {i+1: vdb[i] for i in range(len(visible_exploits))}

    for i, exploit in exploits.items():
            print("{:2d}. {}".format(i, exploit))

    sel = 0
    while sel not in exploits.keys():
        try:
            sel = int(input("Exploit selection > "))
        except ValueError:
            print("Enter a number")

    addr = input("Enter target IP address > ")
    port = -1
    while port < 0:
        try:
            port = int(input("Select port to use > "))
        except ValueError:
            print("Enter a number")
    chkrun = input("Type 'run' to begin exploitation > ")

    if chkrun != 'run':
        return

    dots("Running exploit", 9, 0.333)

    try:
        box = kwargs['game'].network[addr]
        vuln = exploits[sel]
    except KeyError:
        print("Invalid options specified.")
        return

    if (vuln in box.vulns) and \
       (port == box.vulns[vuln][1]):
        box.vulns[vuln][0] = True
        print("Exploit success!")
        kwargs['shell'].run_command(
            kwargs['shell']._get_command_from_str('shell'),
            ['new', addr]
        )
    else:
        print("Exploit failed")
